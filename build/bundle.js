(()=>{"use strict";function t(t){t.prototype._className=t.name,c[t.name]=t}class e{static log(...t){console.log(t)}static error(...t){console.error(t)}static warn(...t){console.warn(t)}static errorCode(t){}}var s,i,n,o,r,h,a,l=function(t,e,s,i){var n,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,i);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(r=(o<3?n(r):o>3?n(e,s,r):n(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r};const c={};var d;!function(t){t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.ZERO=48]="ZERO",t[t.ONE=49]="ONE",t[t.TWO=50]="TWO",t[t.THREE=51]="THREE",t[t.FOUR=52]="FOUR",t[t.FIVE=53]="FIVE",t[t.SIX=54]="SIX",t[t.SEVEN=55]="SEVEN",t[t.EIGHT=56]="EIGHT",t[t.NINE=57]="NINE",t[t.LEFT=37]="LEFT",t[t.UP=38]="UP",t[t.RIGHT=39]="RIGHT",t[t.DOWN=40]="DOWN",t[t.SPACE=32]="SPACE"}(d||(d={}));let _=class{constructor(t){console.log("mouseevent",t),this.x=t.offsetX,this.y=-t.offsetY,this.offsetX=t.offsetX,this.offsetY=-t.offsetY,this.screenX=t.screenX,this.screenY=-t.screenY}getLocation(){return new P(this.x,this.y)}};_=l([t],_);let u=s=class{constructor(){this.htmlCanvas=null,this.canvas=null,this.camera=null,this.context=null,this.audio={},this.world=null,this.mouse={x:void 0,y:void 0,pressed:!1},this.offset=[0,0],this.fps=60,this.keysPressed=[],this.maxFrameTime=.03,this.time=void 0,this.frameCacul=0,this._nextWorld=null,this.worldMap=new Map,this.isRabbitRun=!1,this.updateId=null,this.debugMode=!1,this.isMouseDown=!1,s.Instance||(s.Instance=this,p=s.Instance,this.entitySystem=new g,this.compSystem=new m,this.eventSystem=new y,this.tweenSystem=new w,this.debugTools=new K)}get winSize(){return new N(0,0,this.htmlCanvas.width,this.htmlCanvas.height)}init(t){t=t||"rabbit-canvas";const s=document.getElementById(t);if(this.htmlCanvas=s,this.context=s.getContext("2d"),this.eventSystem.initEventRegister(),document.defaultView&&document.defaultView.getComputedStyle){const t=+document.defaultView.getComputedStyle(s,null).paddingLeft||0,e=+document.defaultView.getComputedStyle(s,null).paddingTop||0,i=+document.defaultView.getComputedStyle(s,null).borderLeftWidth||0,n=+document.defaultView.getComputedStyle(s,null).borderTopWidth||0;this.offset=[t+i,e+n]}this.htmlCanvas.width=this.htmlCanvas.clientWidth,this.htmlCanvas.height=this.htmlCanvas.clientHeight,this.resetCamera(),e.log("rabbit 初始化完成")}resetCamera(){this.camera={x:0,y:0}}imageError(t){alert("Could not load "+t+".")}static loadImage(t){if(t in this.images)return this.images[t];const e=new Image;return e.src=t,e.onload=()=>{e.valid=!0,console.log("img success",e)},e.onerror=()=>{e.valid=!1,s.Instance.imageError(e.src)},this.images[t]=e,e}static loadImageAsync(t){return new Promise(((e,i)=>{t in this.images&&e(this.images[t]);const n=new Image;n.src=t,n.onload=()=>{n.valid=!0,this.images[t]=n,e(n)},n.onerror=()=>{n.valid=!1,s.Instance.imageError(n.src),i()}}))}static loadAudio(t){let e=null;for(var s=0;s<this.audioChannels.length;++s)if(e=this.audioChannels[s],e.ended)return e.pause(),e.currentTime=0,e.src=t,e;return e=new Audio(t),this.audioChannels.push(e),e}_mousePosition(t){let e=0,s=0;const i=this.htmlCanvas;if(i.offsetParent)do{e+=i.offsetLeft,s+=i.offsetTop}while(i==i.parentElement);return[t.pageX-e+this.offset[0],t.pageY-s+this.offset[1]]}_canvasMouseDown(t){t.preventDefault(),this.mouseDown(t)}keyDown(t){this.keysPressed[t.keyCode]||(this.keysPressed[t.keyCode]=!0,this.world.keyDown(t.keyCode))}keyUp(t){this.keysPressed[t.keyCode]=!1,this.world.keyUp(t.keyCode)}mouseDown(t){this.isMouseDown=!0,this.world.mouseDown(t),this.mouse.pressed=!0}mouseUp(t){this.isMouseDown=!1,this.world.mouseUp(t),this.mouse.pressed=!0}mousePress(t){if(this.isMouseDown){var e=s.Instance._mousePosition(t);this.mouse.x=e[0],this.mouse.y=e[1],this.world.mousePress(t)}}mouseOut(t){this.isMouseDown=!1,this.mouse.x=void 0,this.mouse.y=void 0}playSfx(t){new O(t).play()}run(){const t=1e3/this.fps;this.time=Date.now(),this.start(),this.updateId=setInterval((()=>{this.update()}),t)}setBackground(t){this.htmlCanvas.style.backgroundImage="url("+t+")",this.context.clearRect(0,0,this.htmlCanvas.width,this.htmlCanvas.height)}setWorld(t){this._nextWorld=t}addWorld(t){this.worldMap.set(t.name,t)}runWorld(t){this.isRabbitRun&&this.stop(),this.world=this.worldMap.get(t),this.world?(this.resetCamera(),this.world.init(),this.run(),this.isRabbitRun=!0):e.error("runWorld world不存在")}stop(){return!!this.updateId&&(clearInterval(this.updateId),this.world.stop(),this.updateId=null,this.isRabbitRun=!1,!0)}start(){this.world.start()}update(){let t=(Date.now()-this.time)/1e3;t>this.maxFrameTime&&(t=this.maxFrameTime),this.time=Date.now(),this.frameCacul++,this.world.update(t),this.context.clearRect(0,0,this.htmlCanvas.width,this.htmlCanvas.height),this.world.draw(),this.mouse.pressed=!1,this._nextWorld&&(this.world=this._nextWorld,this._nextWorld=null)}message(t,...e){s.Instance.eventSystem.sendMessage(new x(t,e))}};u.Instance=null,u.images=new Map,u.audioChannels=[],u.version="0.3",u=s=l([t],u);let p=null,g=i=class{constructor(){i.Instance=this}add(t){const e=u.Instance.world;e.entities.push(t),t.id=e.maxId++,t.world=e,1==t.isRemoved&&(t.isRemoved=!1),t.onAdd()}draw(){const t=u.Instance.world.entities;t.sort(((t,e)=>t.graphic?e.graphic?t.graphic.z==e.graphic.z?t.id-e.id:t.graphic.z-e.graphic.z:1:-1));for(let e=0;e<t.length;++e)t[e].draw()}destroyEntity(t){t.onDestroy(),u.Instance.world.preDestroys.push(t)}removeEntity(t){t.isRemoved=!0,t.parent=null,u.Instance.world.removes.push(t)}};g=i=l([t],g);let m=n=class{constructor(){n.Instance=this}};m=n=l([t],m);let y=o=class{constructor(){o.Instance=this}initEventRegister(){u.Instance.htmlCanvas.onmousedown=t=>{u.Instance._canvasMouseDown(t)},document.onkeydown=t=>{u.Instance.keyDown(t)},document.onkeyup=t=>{u.Instance.keyUp(t)},u.Instance.htmlCanvas.onmousemove=t=>{u.Instance.mousePress(t)},u.Instance.htmlCanvas.onmouseup=t=>{u.Instance.mouseUp(t)},u.Instance.htmlCanvas.onmouseout=t=>{u.Instance.mouseOut(t)}}start(){const t=u.Instance.world.entities;for(let e=0;e<t.length;++e){const s=t[e];s.active&&s.start()}}update(t){const e=u.Instance.world,s=e.entities;for(let e=0;e<s.length;++e){const i=s[e];i.active&&i.update(t)}const i=e.preDestroys;if(0!=i.length){for(let t=0;t<i.length;++t)j.deleteItemFromList(i[t],s);e.preDestroys=[]}}keyDown(t){this.sendMessage(new x("keyDown",t))}keyPress(t){this.sendMessage(new x("keyPress",t))}keyUp(t){this.sendMessage(new x("keyUp",t))}mouseDown(t){console.log("mouseEvent",t),this.sendMessage(new x("mouseDown",t))}mousePress(t){this.sendMessage(new x("mousePress",t))}mouseUp(t){this.sendMessage(new x("mouseUp",t))}mouseOut(t){this.sendMessage(new x("mouseOut",t))}removeListener(t,e,s){const i=u.Instance.world.eventListeners,n=[];for(let o=i.length-1;o>=0;--o){const r=i[o];e?r.eventType==t&&r.func==e&&n.push(r):e&&s?r.eventType==t&&r.func==e&&r.entity==s&&n.push(r):r.eventType==t&&n.push(r)}n.forEach((t=>{j.deleteItemFromList(t,i)}))}addListener(t){u.Instance.world.eventListeners.push(t)}sendMessage(t){const e=u.Instance.world.eventListeners,s=[];for(let i=e.length-1;i>=0;--i){const n=e[i];n.checkEmit(t)&&n.isOnce&&s.push(n)}s.forEach((t=>{j.deleteItemFromList(t,e)}))}};y=o=l([t],y);class w{constructor(){w.Instance=this}update(t){const e=u.Instance.world.tweens,s=[];for(let t=e.length-1;t>=0;--t){const i=e[t];i.target&&!i.target.hasDestroyed||s.push(i),i.isPlaying()?i.update(u.Instance.time):s.push(i)}s.forEach((t=>{j.deleteItemFromList(t,e)}))}addTween(t){u.Instance.world.tweens.push(t)}}class f{constructor(t,e,s,i,n){this.isOnce=!0,this.eventType=t,this.func=e,this.bind=s,this.entity=i,this.isOnce=n}checkEmit(t){if(this.entity&&this.entity.active&&this.func){if(t.eventType==this.eventType){if(this.eventType==v.POSITION_CHANGED){if(t.args[0]!=this.entity)return!1}else if(this.eventType==v.MOUSE_DOWN){const s=[t.args[0].x,t.args[0].y];if(!this.entity.transform.getRect().collidePoint(s))return e.log("点击失败"),!1;this.entity._isMouseDown=!0,this.entity.listenOnce(v.MOUSE_UP,(()=>this.entity._isMouseDown=!1)),e.log("点击成功")}else if((this.eventType==v.MOUSE_PRESS||this.eventType==v.MOUSE_UP||this.eventType==v.MOUSE_OUT)&&!this.entity._isMouseDown)return!1;return this.func.apply(this.bind,t.args),!0}return!1}}}class x{constructor(t,...e){this.eventType=t,this.args=e}}var v;!function(t){t.MOUSE_DOWN="mouseDown",t.MOUSE_UP="mouseUp",t.MOUSE_PRESS="mousePress",t.MOUSE_OUT="mouseOut",t.KEY_DOWN="keyDown",t.KEY_PRESS="keyPress",t.KEY_UP="keyUp",t.POSITION_CHANGED="positionChanged"}(v||(v={}));let I=class{clone(){let t=function(){};return t.prototype=this,new t}extend(t){let e=this.clone();for(let s in t)e[s]=t[s];return e}};I=l([t],I);let S=class extends I{_onLoad(){this.onLoad(),this.start()}onLoad(){}start(){}lateUpdate(){}onEnable(){}onDestroy(){}update(t){}addComponent(t){return this.entity.addComponent(t)}getComponent(t){return this.entity.getComponent(t)}};S=l([t],S);let C=class extends S{};C=l([t],C);let P=r=class{constructor(t,e){this.x=t||0,this.y=e||0}get x(){return this._x}set x(t){this._x=t}get width(){return this._x}set width(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get height(){return this._y}set height(t){this._y=t}sub(t){return new r(this.x-t.x,this.y-t.y)}};P=r=l([t],P);let E=class{constructor(t,e,s){"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=s||0)}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}get z(){return this._z}set z(t){this._z=t}};E=l([t],E);let T=class{constructor(){this.isAngleChange=!1}};T=l([t],T);let M=class extends S{constructor(t,e,s,i,n,o){super(),this.changeSign=new T,this._worldPosition=new E,this._position=new E,this._worldAngle=0,this._angle=0,this._anchor=new P(.5,.5),this._scale=new P(1,1),this._worldScale=new P(1,1),this._color=U.BLACK,this._rect=new N(0,0,0,0),this.x=t||this.x,this.y=e||this.y,this.width=s||this.width,this.height=i||this.height,this._scale.x=n||this._scale.x,this._scale.y=o||this._scale.y}_setRoot(t){this.width=t.resolution.width,this.height=t.resolution.height,this._worldPosition=new E(t.resolution.width/2,-t.resolution.height/2),this._position=new E(0,0),this.updateRect()}init(t,e,s,i,n,o){this.x=t||this.x,this.y=e||this.y,this.width=s||this.width,this.height=i||this.height,this.scaleX=n||this.scaleX,this.scaleY=o||this.scaleY}get worldPosition(){return this._worldPosition}set worldPosition(t){this._worldPosition=t,this.updateLocalPosition()}get worldX(){return this._worldPosition.x}set worldX(t){this._worldPosition.x=t,this.updateLocalPosition()}get worldY(){return this._worldPosition.y}set worldY(t){this._worldPosition.y=t,this.updateLocalPosition()}get worldZ(){return this._worldPosition.z}set worldZ(t){this._worldPosition.z=t,this.updateLocalPosition()}get position(){return this._position}set position(t){this._position=t,this.updateWorldPosition()}get x(){return this._position.x}set x(t){console.log("坐标改变"),this._position.x=t,this.updateWorldPosition()}get y(){return this._position.y}set y(t){this._position.y=t,this.updateWorldPosition()}get z(){return this._position.z}set z(t){this._position.z=t,this.updateWorldPosition()}get worldAngle(){return this._worldAngle}get angle(){return this._angle}set angle(t){this._angle=t,this.updateWorldAngle()}get anchor(){return this._anchor}set anchor(t){this._anchor=t,this.updateAnchor()}get size(){return new P(this._rect.w,this._rect.h)}set size(t){this._rect.w=t.width,this._rect.h=t.height,this.updateSize()}get width(){return this._rect.width}set width(t){this._rect.w=t,this.updateSize()}get height(){return this._rect.height}set height(t){this._rect.height=t,this.updateSize()}get right(){return this.position.x+this.width/2}get top(){return this.position.y+this.height/2}get left(){return this.position.x-this.width/2}get down(){return this.position.y-this.height/2}get scale(){return this._scale}setScale(t){this._scale=t,this.updateWorldScale(),this.updateForChildrenAndGraphic()}get scaleX(){return this._scale.x}set scaleX(t){this._scale.x=t,this.updateWorldScale(),this.updateForChildrenAndGraphic()}get scaleY(){return this._scale.y}set scaleY(t){this._scale.y=t,this.updateWorldScale(),this.updateForChildrenAndGraphic()}get worldScale(){return this._worldScale}get worldScaleX(){return this._worldScale.x}get worldScaleY(){return this._worldScale.y}get parent(){return this.entity&&this.entity.parent?this.entity.parent.transform:null}get children(){return this.entity?this.entity.children.map((t=>t.transform)):[]}get color(){return this._color}set color(t){this._color=t,this.updateColorGraphic()}tween(){}getRect(){return this._rect}updateForParent(){this.parent&&(this.updateScaleGraphic(),this.updateWorldPosition(),this.updateWorldScale())}updateChildren(){const t=this.children;if(t&&0!=t.length)for(let e=0;e<t.length;e++)t[e].updateForParent()}updateForChildrenAndGraphic(){this.updateScaleGraphic(),this.updateChildren()}updateScaleGraphic(){this.entity&&this.entity.graphic&&this.entity.graphic.updateScale()}updateColorGraphic(){this.entity.graphic.updateNormalColor()}updateWorldScale(){this.parent&&this.parent.parent?(this._worldScale=new P(this.parent.worldScaleX*this.parent.scaleX,this.parent.worldScaleY*this.parent.scaleY),console.log("entity3",this.entity.name)):this.parent&&!this.parent.parent?(this._worldScale=new P(this.parent.worldScaleX,this.parent.worldScaleY),console.log("entity2",this.entity.name)):(this._worldScale=new P(this.scale.x,this.scale.y),console.log("entity1",this._worldScale))}updateSize(){}updateAnchor(){}updateWorldAngle(){this._worldAngle=this.parent?this.parent.worldAngle+this._angle:this._angle,this.updateChildren()}setPosition(t,e){"number"==typeof t?(this._position.x=t,this._position.y=e||0==e?e:this._position.y):(this._position.x=t.x,this._position.y=t.y,t.z&&(this._position.z=t.z)),this.updateWorldPosition()}updateWorldPosition(){this._worldPosition.x=this.parent?this.parent.worldPosition.x+this.x:this.x,this._worldPosition.y=this.parent?this.parent.worldPosition.y+this.y:this.y,this._worldPosition.z=this.parent?this.parent.worldPosition.z+this.z:this.z;try{this.entity&&u.Instance.world.eventSystem.sendMessage(new x(v.POSITION_CHANGED,this.entity))}catch(t){console.log(t)}this.updateRect(),this.updateChildren()}updateLocalPosition(){this._position.x=this.parent?this.worldPosition.x-this.parent.worldPosition.x:this.worldX,this._position.y=this.parent?this.worldPosition.y-this.parent.worldPosition.y:this.worldY,this._position.z=this.parent?this.worldPosition.z-this.parent.worldPosition.z:this.worldZ;try{this.entity&&u.Instance.world.eventSystem.sendMessage(new x(v.POSITION_CHANGED,this.entity))}catch(t){console.log(t)}this.updateRect(),this.updateChildren()}updateRect(){this._rect.x=this.worldPosition.x,this._rect.y=this.worldPosition.y}static calcNewPoint(t,e,s){let i=s*Math.PI/180,n=Math.cos(i),o=Math.sin(i);const r=(t.x-e.x)*n-(t.y-e.y)*o+e.x,h=(t.x-e.x)*o+(t.y-e.y)*n+e.y;return new P(r,h)}};M=l([t],M);let b=class extends I{constructor(t,e,s,i,n,o,r){super(),this._active=!0,this._hasDestroyed=!1,this._isActiveOnRemoved=!0,this._isRemoved=!1,this.components=[],this.children=[],this._parent=null,this.name=t||"entity"+Math.floor(1e5*Math.random()),this.transform=this.addComponent(M),this.transform.init(e,s,i,n,o,r),this.type="entity",this.world=null}get hasDestroyed(){return this._hasDestroyed}get active(){return this._active}set active(t){this._active=t}get isRemoved(){return this._isRemoved}set isRemoved(t){this._isRemoved=t,this._isRemoved?(this._isActiveOnRemoved=this.active,this.active=!1):this.active=this._isActiveOnRemoved}get parent(){return this._parent}set parent(t){this.setParent(t)}onDestroy(){}onAdd(){}collide(t){return!1}draw(){this.active&&this.graphic&&this.graphic.visible&&this.graphic.draw()}start(){e.log(this.name+" start执行");const t=this.components.length;if(0!=t)for(let e=0;e<t;e++)this.components[e]._onLoad()}update(t){const e=this.components.length;if(0!=e)for(let s=0;s<e;s++)this.components[s].update(t)}addComponent(t){let s=null;if("string"==typeof t)try{c[t]?s=new c[t].prototype.constructor:e.log("不存在此component",t)}catch(t){e.error("通过string字符串addComponent出错",t)}else try{s=new t}catch(t){e.error("通过传入类addComponent错误，可能原因为类实现有误")}return s&&(this.components.push(s),s.entity=this,s.draw&&(this.graphic=s),u.Instance&&u.Instance.isRabbitRun&&s._onLoad()),s}getComponent(t){if("string"==typeof t)for(let e=0;e<this.components.length;e++){const s=this.components[e];if(s.__proto__.constructor.name==t)return s}else for(let e=0;e<this.components.length;e++){const s=this.components[e];if(s.__proto__.constructor.name==t.prototype.constructor.name)return s}return null}addChild(t){try{if(!t)return e.warn("要添加的子节点不存在");t.parent&&t.parent.removeChild(this),t._parent=this,this.children.push(t),this.world.add(t),t.transform.updateWorldPosition()}catch(t){console.log("world可能不存在",t)}}removeChild(t){j.deleteItemFromList(t,this.children)}destroy(){try{this.parent=null,this.world.destroyEntity(this),this.children.forEach((t=>{t.destroy()})),this._hasDestroyed=!0}catch(t){console.log("world可能不存在",t)}}remove(){try{this.world.removeEntity(this)}catch(t){console.log("world可能不存在",t)}}setParent(t){t?t.addChild(this):(this.parent&&this.parent.removeChild(this),this._parent=null)}listen(t,e,s){u.Instance.eventSystem.addListener(new f(t,e,s,this,!1))}listenOnce(t,e,s){u.Instance.eventSystem.addListener(new f(t,e,s,this,!0))}listenOff(t,e,s){u.Instance.eventSystem.removeListener(t,e,s)}};b.EventType=v,b=l([t],b);let O=class extends I{constructor(t){super(),this.soundUrl=t}play(){this.audio=u.loadAudio(this.soundUrl),this.audio.play()}};O=l([t],O);let R=class extends I{static play(t){u.loadAudio(t).play()}};R=l([t],R);let A=class extends I{constructor(t){super(),this.entities=[],this.preDestroys=[],this.removes=[],this.maxId=0,this.entitySystem=u.Instance.entitySystem,this.eventSystem=u.Instance.eventSystem,this.tweenSystem=u.Instance.tweenSystem,this.eventListeners=[],this.tweens=[],this.name=t}add(t){this.entitySystem.add(t)}destroyEntity(t){this.entitySystem.destroyEntity(t)}removeEntity(t){this.entitySystem.removeEntity(t)}draw(){this.entitySystem.draw()}filter(t){let e=[];for(let s=0;s<this.entities.length;++s)t(this.entities[s])&&e.push(this.entities[s]);return e}getType(t){return this.filter((e=>e.type==t))}keyDown(t){this.eventSystem.keyDown(t)}keyUp(t){this.eventSystem.keyUp(t)}keyPress(t){this.eventSystem.keyPress(t)}mouseDown(t){const e=new _(t);this.eventSystem.mouseDown(e)}mousePress(t){const e=new _(t);this.eventSystem.mousePress(e)}mouseUp(t){const e=new _(t);this.eventSystem.mouseUp(e)}mouseOut(t){const e=new _(t);this.eventSystem.mouseOut(e)}update(t){this.eventSystem.update(t),this.tweenSystem.update(t)}start(){e.log("start事件总线执行"),this.eventSystem.start()}stop(){this.entities=[],this.preDestroys=[],this.eventListeners=[],this.tweens=[],this.maxId=0}};A=l([t],A);let D=class{constructor(t,e){this.other=t,this.rect=e}};D=l([t],D);let k=class extends S{constructor(){super(...arguments),this.z=0,this.w=0,this.h=0,this.visible=!0}updateNormalColor(){}updateScale(){}draw(){}};var F;k=l([t],k),function(t){t.left="left",t.right="right",t.center="center",t.start="start",t.end="end"}(F||(F={}));let U=h=class{constructor(t,s,i,n){if(this._alpha=1,"string"==typeof t)if(h.isHex(t)){const e=h.hexToRgb(t);this.r=e.r,this.g=e.g,this.b=e.b}else e.warn("通过hex码初始化颜色错误"),this.r=0,this.g=0,this.b=0,this.alpha=n||1;else this.r=t,this.g=s,this.b=i}static isNumberAndAToZ(t){return/^[\da-z]+$/i.test(t)}static isHex(t){return!(7!=t.length||"#"!=t[0]||!this.isNumberAndAToZ(t.substring(1,t.length)))}static hexToRgb(t){return{r:parseInt("0x"+t.slice(1,3)),g:parseInt("0x"+t.slice(3,5)),b:parseInt("0x"+t.slice(5,7))}}static rgbToHex(t,e,s){return(t<<16|e<<8|s).toString(16)}get r(){return this._r}set r(t){this._r=t}get g(){return this._g}set g(t){this._g=t}get b(){return this._b}set b(t){this._b=t}get alpha(){return this._alpha}set alpha(t){this._alpha=t}static get BLACK(){return new h("#000000")}static get WHITE(){return new h("#FFFFFF")}static get RED(){return new h("#FF0000")}static get YELLOW(){return new h("FFFF00")}static get BLUE(){return new h("#0000FF")}static get GREEN(){return new h("#008000")}static get ORANGE(){return new h("#FFA500")}static get PINK(){return new h("#FFC0CB")}};U=h=l([t],U);let W=class extends k{constructor(t,e,s,i,n,o,r){super(),this._text=s||"",this.font=i||"sans",this.colour=n||"white",this.textSize=o||14,this.align=r||"left",u.Instance.context.textBaseline="top",u.Instance.context.textAlign=this.align,u.Instance.context.font=this.textSize+"px "+this.font,u.Instance.context.fillStyle=this.colour,this.w=u.Instance.context.measureText(s).width,this.h=this.textSize}get text(){return this._text}set text(t){this._text=t,this.updateSize()}get textSize(){return this._textSize}set textSize(t){this._textSize=t,this.updateSize()}setAlign(t){this.align=t}updateNormalColor(){}updateScale(){}draw(){if(!this.entity)return;const t=u.Instance.context,e=this.entity.transform;t.save(),t.textBaseline="top",t.textAlign=this.align,t.font=this.textSize+"px "+this.font,t.fillStyle=this.colour;const s=e.worldAngle*Math.PI/180;if(t.translate(e.worldX,-e.worldY),t.rotate(s),t.scale(e.scaleX,e.scaleY),t.translate(-e.worldX,e.worldY),e.parent){const s=e.parent.worldAngle*Math.PI/180;t.translate(e.parent.worldX,-e.parent.worldY),t.scale(e.worldScaleX,e.worldScaleY),t.rotate(s),this.renderText(this.text,e.x,-e.y)}else t.translate(e.worldX,-e.worldY),t.scale(e.worldScaleX,e.worldScaleY),this.renderText(this.text,0,0);if(t.restore(),u.Instance.debugMode){t.save();const s=e.getRect();t.lineWidth=2,t.strokeStyle="red",t.strokeRect(s.x-s.width/2,-s.y-s.height/2,s.width,s.height),t.restore()}}renderText(t,e,s,i){s-=this.h/2;const n=t.split("\n"),o=u.Instance.context;for(let t=0;t<n.length;t++){const i=n[t];o.fillText(i,e,s),s+=this.textSize}}updateSize(){const t=u.Instance.context;t.save(),t.textBaseline="top",t.textAlign=this.align,t.font=this.textSize+"px "+this.font,this.h=0,this.w=0;const e=this.text.split("\n");for(let t=0;t<e.length;t++){const s=e[t];this.h+=this.textSize;const i=u.Instance.context.measureText(s).width;this.w=i>this.w?i:this.w}this.entity&&(this.entity.transform.size=new P(this.w,this.h)),t.restore()}update(t){}};W.TextAlignType=F,W=l([t],W);let L=class extends I{constructor(t,e,s,i){super(),"object"==typeof t?(this.left=t.x-t.w/2,this.right=t.x+t.w/2,this.top=t.y+t.h/2,this.down=t.y-t.h/2):(this.left=t-s/2,this.right=t+s/2,this.top=e+i/2,this.down=e-i/2)}};L=l([t],L);let N=class extends I{constructor(t,e,s,i){super(),this.x=t||0,this.y=e||0,this.w=s||0,this.h=i||0}set w(t){this._width=t}get w(){return this._width}set width(t){this._width=t}get width(){return this._width}set h(t){this._height=t}get h(){return this._height}set height(t){this._height=t}get height(){return this._height}bottom(){return this.y+this.h}collidePoint(t){return console.log("point",t),console.log("rect",this),t[0]>=this.x-this.w/2&&t[0]<this.x+this.w/2&&t[1]>=this.y-this.h/2&&t[1]<this.y+this.h/2}collideRect(t){return!(this.x>t.x+t.w/2+this.w/2||t.x>this.x+this.w/2+t.w/2||this.y>t.y+t.h/2+this.h/2||t.y>this.y+this.h/2+t.h/2)}intersects(t){return this.collideRect(t)}left(){return this.x}place(t){this.x=t[0],this.y=t[1]}right(){return this.x+this.w}top(){return this.y}};N=l([t],N);let z=class extends I{constructor(t,e,s){super(),this.x=t,this.y=e,this.radius=s}collideCircle(t){var e=this.x-t.x,s=this.y-t.y,i=e*e+s*s,n=this.radius+t.radius;return i<=n*n}collidePoint(t){var e=[t[0]-this.x,t[1]-this.y];return e[0]*e[0]+e[1]*e[1]<=this.radius*this.radius}place(t){this.x=t[0],this.y=t[1]}};z=l([t],z);let Y=class extends k{constructor(t){super(),this.graphics=t||[]}setGraphics(t){this.graphics=t}draw(){if(!this.entity)return;const t=this.entity.transform;u.Instance.context.save(),u.Instance.context.translate(t.worldX,t.worldY);for(let t=0;t<this.graphics.length;++t)this.graphics[t].draw();u.Instance.context.restore()}pop(){this.graphics.pop()}push(t){this.graphics.push(t)}move(t,e){if(!this.entity)return;const s=this.entity.transform;s.worldX+=t,s.worldY+=e;for(let s=0;s<this.graphics.length;++s)this.graphics[s].entity.transform.worldX+=t,this.graphics[s].entity.transform.worldY+=e}place(t){if(!this.entity)return;const e=this.entity.transform;var s=t[0]-e.worldX,i=t[1]-e.worldY;this.move(s,i)}destroy(t){for(let e=0;e<this.graphics.length;++e)this.graphics[e]==t&&this.graphics.slice(e)}shift(){this.graphics.shift()}unshift(t){this.graphics.unshift(t)}update(t){for(var e=0;e<this.graphics.length;++e)this.graphics[e].update(t)}};Y=l([t],Y);let X=class extends I{};X=l([t],X);let B=class extends X{constructor(t){super(),t&&(this.imageUrl=t)}get imageUrl(){return this._imageUrl}set imageUrl(t){this._imageUrl=t,this.image=u.loadImage(t)}set image(t){this._image=t,this.updateSize()}get image(){return this._image}setImageAsync(t){return e=this,s=void 0,n=function*(){this._imageUrl=t,this.image=yield u.loadImageAsync(t)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(r,h)}a((n=n.apply(e,s||[])).next())}));var e,s,i,n}isValid(){return this.image.valid}updateSize(){this.width=this.image.width,this.height=this.image.height,this.size=new P(this.width,this.height)}};B=l([t],B);let H=class extends k{constructor(t,e,s){super(),this.ignoreCamera=!1,this.alpha=1,s&&(this.spriteFrame=s)}get width(){return this.spriteFrame.width}get height(){return this.spriteFrame.height}set spriteFrame(t){this._spriteFrame=t,this.updateSize()}get spriteFrame(){return this._spriteFrame}draw(){if(!this.spriteFrame||!this.spriteFrame.isValid()||!this.entity)return;const t=u.Instance.context,e=this.entity.transform;t.save(),t.globalAlpha=this.alpha;const s=e.worldAngle*Math.PI/180;if(this.ignoreCamera?t.translate(Math.floor(e.worldX-this.width/2),-Math.floor(e.worldY+this.height/2)):t.translate(Math.floor(e.worldX-this.width/2+u.Instance.camera.x),-Math.floor(e.worldY+this.height/2+u.Instance.camera.y)),t.rotate(s),t.scale(e.scaleX,e.scaleY),this.ignoreCamera?t.translate(-Math.floor(e.worldX-this.width/2),+Math.floor(e.worldY+this.height/2)):t.translate(-Math.floor(e.worldX-this.width/2+u.Instance.camera.x),Math.floor(e.worldY+this.height/2+u.Instance.camera.y)),e.parent){const s=e.parent.worldAngle*Math.PI/180;this.ignoreCamera?t.translate(Math.floor(e.parent.worldX-this.width/2),-Math.floor(e.parent.worldY+this.height/2)):t.translate(Math.floor(e.parent.worldX-this.width/2+u.Instance.camera.x),-Math.floor(e.parent.worldY+this.height/2+u.Instance.camera.y)),t.scale(e.worldScaleX,e.worldScaleY),t.rotate(s),t.drawImage(this.spriteFrame.image,e.x,-e.y)}else this.ignoreCamera?t.translate(Math.floor(e.worldX-this.width/2),-Math.floor(e.worldY+this.height/2)):t.translate(Math.floor(e.worldX-this.width/2+u.Instance.camera.x),-Math.floor(e.worldY+this.height/2+u.Instance.camera.y)),t.scale(e.worldScaleX,e.worldScaleY),t.drawImage(this.spriteFrame.image,0,0);if(t.globalAlpha=1,t.restore(),u.Instance.debugMode){t.save();const e=this.entity.transform.getRect();t.lineWidth=2,t.strokeStyle="red",t.strokeRect(e.x-e.width/2,-e.y-e.height/2,e.width,e.height),t.restore()}}update(t){this.spriteFrame}updateSize(){this.entity&&(this.entity.transform.size=new P(this.width,this.height))}};H=l([t],H);let G=a=class extends S{constructor(){if(super(),this.isFitWidth=!1,this.isFitHeight=!0,a.Instance)return null;a.Instance=this,u.Instance.canvas=this,this.resolution={width:u.Instance.htmlCanvas.width,height:u.Instance.htmlCanvas.height},e.log("Canvas width: ",this.resolution.width),e.log("Canvas height: ",this.resolution.height)}onLoad(){this.entity.transform._setRoot(this)}};G=a=l([t],G);let V=class extends k{constructor(t,e,s,i,n){super(),this.ignoreCamera=!1,this.origin=[0,0],this.scale=1,this.image=u.loadImage(s),this.frame=0,this.animations={},this.animations=null,this.animation=[],this.fps=0,this.time=0,this.frameWidth=i,this.frameHeight=n,this.flip=!1,this.alpha=1,this.angle=0}add(t,e){this.animations[t]=e}draw(){if(!this.image.valid||!this.entity)return;const t=this.entity.transform;var e=0,s=0;if(this.animation){var i=this.animation[this.frame],n=Math.floor(this.image.width/this.frameWidth);e=i%n*this.frameWidth,s=Math.floor(i/n)*this.frameHeight}u.Instance.context.save(),u.Instance.context.globalAlpha=this.alpha,this.ignoreCamera?u.Instance.context.translate(Math.floor(t.worldX),Math.floor(t.worldY)):u.Instance.context.translate(Math.floor(t.worldX+u.Instance.camera.x),Math.floor(t.worldY+u.Instance.camera.y));var o=.5*this.w,r=.5*this.h;u.Instance.context.translate(o,r),u.Instance.context.rotate(this.angle),u.Instance.context.translate(-o,-r),this.flip&&(u.Instance.context.scale(-1,1),u.Instance.context.translate(-this.frameWidth,0)),u.Instance.context.drawImage(this.image,e,s,this.frameWidth,this.frameHeight,0,0,Math.floor(this.frameWidth*this.scale),Math.floor(this.frameHeight*this.scale)),u.Instance.context.globalAlpha=1,u.Instance.context.restore()}place(t){if(!this.entity)return;const e=this.entity.transform;e.worldX=t[0],e.worldY=t[1]}play(t,e,s){this.animation=this.animations[t],this.playing=t,this.fps=e,this.frame=0,this.time=0,this.loop=s,null==s&&(this.loop=!0)}update(t){if(!this.entity)return;const e=this.entity.transform;if(u.Instance.context.save(),this.ignoreCamera?u.Instance.context.translate(Math.floor(e.worldX),Math.floor(e.worldY)):u.Instance.context.translate(Math.floor(e.worldX+u.Instance.camera.x),Math.floor(e.worldY+u.Instance.camera.y)),u.Instance.context.clearRect(0,0,Math.floor(this.w),Math.floor(this.h)),u.Instance.context.restore(),this.w=this.frameWidth,this.h=this.frameHeight,this.time+=t,this.fps>0&&this.time>1/this.fps){for(++this.frame;this.time>1/this.fps;)this.time-=1/this.fps;this.frame>=this.animation.length&&(this.loop?this.frame-=this.animation.length:this.frame=this.animation.length-1)}}};V=l([t],V);let j=class{static deleteItemFromList(t,s){let i=!1;for(let e=0;e<s.length;e++)if(t==s[e]){s.splice(e,1),i=!0;break}i||e.warn("deleteItemFromList方法未找到要删除的元素")}};j=l([t],j);let K=class{static drawRect(t){u.Instance.context.save();const e=t.getRect();u.Instance.context.lineWidth=4,u.Instance.context.strokeStyle="red",u.Instance.context.rect(e.x-e.width/2,e.y-e.height/2,e.width,e.height),u.Instance.context.stroke(),u.Instance.context.restore()}};K=l([t],K);class Z extends S{init(t,e,s){this.gx=t,this.gy=e,this.dark=new B("graphics/dark.png"),this.light=new B("graphics/light.png");const i=this.dark.width/2;let n=t,o=e;console.log("radius",i),this.entity.transform.setPosition(i+n*(2*i+1),-i-(o*i*2+1)),this.radius=i,this.lit=!0,this.board=s,this.circle=new z(n+i,o+i,i),this.spr=this.entity.addComponent(H),this.spr.spriteFrame=this.dark}onLoad(){this.entity.listen(v.MOUSE_DOWN,(t=>{this.board.light(this.gx,this.gy)}),this)}flip(){this.lit=!this.lit}update(t){this.lit?this.spr.spriteFrame=this.light:this.spr.spriteFrame=this.dark}}class Q extends S{onLoad(){return t=this,e=void 0,i=function*(){console.log("board start"),this.lights=[],yield u.loadImageAsync("graphics/dark.png"),yield u.loadImageAsync("graphics/light.png");for(let t=0;t<5;++t)for(let e=0;e<5;++e){const s=new b,i=s.addComponent(Z);i.init(e,t,this),this.lights.push(i),u.Instance.world.add(s)}for(let t=0;t<8;++t)this.light(Math.floor(5*Math.random()),Math.floor(5*Math.random()))},new((s=void 0)||(s=Promise))((function(n,o){function r(t){try{a(i.next(t))}catch(t){o(t)}}function h(t){try{a(i.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,h)}a((i=i.apply(t,e||[])).next())}));var t,e,s,i}light(t,e){console.log("处理",t,e),this.lights[5*e+t].flip(),t<4&&this.lights[5*e+t+1].flip(),e<4&&this.lights[5*(e+1)+t].flip(),t>0&&this.lights[5*e+t-1].flip(),e>0&&this.lights[5*(e-1)+t].flip(),this.checkWon()}checkWon(){for(let t=0;t<this.lights.length;t++)if(!this.lights[t].lit)return;R.play("audio/bell.ogg"),alert("Victory!")}}class q extends S{init(t,e){return s=this,i=void 0,o=function*(){yield u.loadImageAsync("graphics/robot.png"),this.entity.transform.x=t,this.entity.transform.y=e,this.image=this.entity.addComponent(H),this.image.spriteFrame=new B("graphics/robot.png")},new((n=void 0)||(n=Promise))((function(t,e){function r(t){try{a(o.next(t))}catch(t){e(t)}}function h(t){try{a(o.throw(t))}catch(t){e(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof n?s:new n((function(t){t(s)}))).then(r,h)}a((o=o.apply(s,i||[])).next())}));var s,i,n,o}}const J={Linear:{None:function(t){return t}},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Cubic:{In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},Quartic:{In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}},Quintic:{In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}},Sinusoidal:{In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.cos(Math.PI*t))}},Exponential:{In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}},Circular:{In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},Elastic:{In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}},Back:{In:function(t){const e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){const e=1.70158;return--t*t*((e+1)*t+e)+1},InOut:function(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}},Bounce:{In:function(t){return 1-J.Bounce.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return t<.5?.5*J.Bounce.In(2*t):.5*J.Bounce.Out(2*t-1)+.5}}},$=J,tt={Linear:function(t,e){const s=t.length-1,i=s*e,n=Math.floor(i),o=tt.Utils.Linear;return e<0?o(t[0],t[1],i):e>1?o(t[s],t[s-1],s-i):o(t[n],t[n+1>s?s:n+1],i-n)},Bezier:function(t,e){let s=0;const i=t.length-1,n=Math.pow,o=tt.Utils.Bernstein;for(let r=0;r<=i;r++)s+=n(1-e,i-r)*n(e,r)*t[r]*o(i,r);return s},CatmullRom:function(t,e){const s=t.length-1;let i=s*e,n=Math.floor(i);const o=tt.Utils.CatmullRom;return t[0]===t[s]?(e<0&&(n=Math.floor(i=s*(1+e))),o(t[(n-1+s)%s],t[n],t[(n+1)%s],t[(n+2)%s],i-n)):e<0?t[0]-(o(t[0],t[0],t[1],t[1],-i)-t[0]):e>1?t[s]-(o(t[s],t[s],t[s-1],t[s-1],i-s)-t[s]):o(t[n?n-1:0],t[n],t[s<n+1?s:n+1],t[s<n+2?s:n+2],i-n)},Utils:{Linear:function(t,e,s){return(e-t)*s+t},Bernstein:function(t,e){const s=tt.Utils.Factorial;return s(t)/s(e)/s(t-e)},Factorial:function(){const t=[1];return function(e){let s=1;if(t[e])return t[e];for(let t=e;t>1;t--)s*=t;return t[e]=s,s}}(),CatmullRom:function(t,e,s,i,n){const o=.5*(s-t),r=.5*(i-e),h=n*n;return(2*e-2*s+o+r)*(n*h)+(-3*e+3*s-2*o-r)*h+o*n+e}}},et=tt;var st;!function(t){t.to="to",t.by="by",t.onComplete="onComplete"}(st||(st={}));class it{static nextId(){return it._nextId++}}it._nextId=0;let nt=()=>u.Instance.time;const ot=class{constructor(t){this._object=t,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=$.Linear.None,this._interpolationFunction=et.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._id=it.nextId(),this._isChainStopped=!1,this._historys=[],this.isAddToRabbit=!1,this._goToEnd=!1}get startTime(){return this._startTime}get target(){return this._object}getId(){return this._id}isPlaying(){return this._isPlaying}isPaused(){return this._isPaused}to(t,e){return this._historys.push({type:st.to,args:[t,e]}),this}_to(t,e){return this._valuesEnd=Object.create(t),void 0!==e&&(this._duration=1e3*e),this}by(t,e){return this._historys.push({type:st.by,args:[t,e]}),this}_by(t,e){this._valuesEnd=Object.create(t);for(const e in t)this._valuesEnd[e]=this._object[e]+t[e];return void 0!==e&&(this._duration=1e3*e),this}duration(t=1e3){return this._duration=t,this}start(){if(this._isPlaying)return this;if(this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._historys.forEach((t=>{this["_"+t.type].apply(this,t.args)})),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(const t in this._valuesStartRepeat)this._swapEndStartRepeatValues(t),this._valuesStart[t]=this._valuesStartRepeat[t]}return this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=nt(),this._startTime+=this._delayTime,this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat),this.isAddToRabbit||(this.isAddToRabbit=!0,u.Instance.world.tweenSystem.addTween(this)),this}_setupProperties(t,e,s,i){for(const n in s){const o=t[n],r=Array.isArray(o),h=r?"array":typeof o,a=!r&&Array.isArray(s[n]);if("undefined"!==h&&"function"!==h){if(a){let t=s[n];if(0===t.length)continue;t=t.map(this._handleRelativeValue.bind(this,o)),s[n]=[o].concat(t)}if("object"!==h&&!r||!o||a)void 0===e[n]&&(e[n]=o),r||(e[n]*=1),i[n]=a?s[n].slice().reverse():e[n]||0;else{e[n]=r?[]:{};for(const t in o)e[n][t]=o[t];i[n]=r?[]:{},this._setupProperties(o,e[n],s[n],i[n])}}}}stop(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this}end(){return this._goToEnd=!0,this.update(1/0),this}pause(t=nt()){return this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=t),this}resume(t=nt()){return this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=t-this._pauseStart,this._pauseStart=0,this):this}stopChainedTweens(){for(let t=0,e=this._chainedTweens.length;t<e;t++)this._chainedTweens[t].stop();return this}delay(t=0){return this._delayTime=1e3*t,this}repeat(t=0){return this._initialRepeat=t,this._repeat=t,this}repeatDelay(t){return this._repeatDelayTime=t,this}yoyo(t=!1){return this._yoyo=t,this}easing(t=$.Linear.None){return this._easingFunction=t,this}interpolation(t=et.Linear){return this._interpolationFunction=t,this}chain(...t){return this._chainedTweens=t,this}onStart(t){return this._onStartCallback=t,this}onUpdate(t){return this._onUpdateCallback=t,this}onRepeat(t){return this._onRepeatCallback=t,this}onComplete(t){return this._historys.push({type:st.onComplete,args:[t]}),this}_onComplete(t){return this._onCompleteCallback=t,this}onStop(t){return this._onStopCallback=t,this}update(t=nt()){if(this._isPaused)return!0;if(!this.isPlaying())return!0;let e,s;const i=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying&&t>i)return!1;if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),s=(t-this._startTime)/this._duration,s=0===this._duration||s>1?1:s;const n=this._easingFunction(s);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,n),this._onUpdateCallback&&this._onUpdateCallback(this._object,s),1===s){if(this._repeat>0){for(e in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[e]||(this._valuesStartRepeat[e]=this._valuesStartRepeat[e]+parseFloat(this._valuesEnd[e])),this._yoyo&&this._swapEndStartRepeatValues(e),this._valuesStart[e]=this._valuesStartRepeat[e];return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=t+this._repeatDelayTime:this._startTime=t+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}for(let t=0,e=this._chainedTweens.length;t<e;t++)this._chainedTweens[t].start();return this._isPlaying=!1,this._onCompleteCallback&&this._onCompleteCallback(this._object),!1}return!0}_updateProperties(t,e,s,i){for(const n in s){if(void 0===e[n])continue;const o=e[n]||0;let r=s[n];const h=Array.isArray(t[n]),a=Array.isArray(r);!h&&a?t[n]=this._interpolationFunction(r,i):"object"==typeof r&&r?this._updateProperties(t[n],o,r,i):(r=this._handleRelativeValue(o,r),"number"==typeof r&&(t[n]=o+(r-o)*i))}}_handleRelativeValue(t,e){return"string"!=typeof e?e:"+"===e.charAt(0)||"-"===e.charAt(0)?t+parseFloat(e):parseFloat(e)}_swapEndStartRepeatValues(t){const e=this._valuesStartRepeat[t],s=this._valuesEnd[t];this._valuesStartRepeat[t]="string"==typeof s?this._valuesStartRepeat[t]+parseFloat(s):this._valuesEnd[t],this._valuesEnd[t]=e}};class rt{constructor(t){this.canvas=t||u.Instance.canvas,this.createGame()}createGame(){console.log("你好",this.canvas),this.setRoot(),this.initBullet(),this.initPlayer(),this.initEnemy(),this.BulletShoot()}BulletShoot(){const t=new ot(this.player).to({},.3).onComplete((()=>{console.log("执行拉拉"),this.shootOneBullet(),t.start()})).start()}gameOver(){const t=new b,e=t.addComponent(W);this.root.addChild(t),e.align=F.center,e.textSize=40,e.lineHeight=40,t.transform.color=U.BLACK,e.text="恭喜你！游戏胜利！",t.transform.setPosition(0,0),setTimeout((()=>{this.root.destroy()}),3e3)}initEnemy(){const t=this.getAscIIModel("                                          __                                          \n                                ________ /||_________                                \n                               |________:||||:________|                               \n                               |        :||||:        |                               \n                               '---..___| || |___..---'                               \n                                       |  ||  |                                       \n                                       |      |                                       \n                                       |      |                                       \n                                       |   .  |                                       \n                                       |   .  |                                       \n                                       |   .  |                                       \n                                       |. . . |                                       \n                                       |   .  |                                       \n                        _______       _|      |_       _______                        \n  _____________________|_______|..--~~:|. . . |:~~--..|_______|_____________________  \n /______________________:  .          :|  .   |:         .   :______________________ \n |:    .         .         .          :|  .   |:         .             .       .   :| \n |:    . . . . . .      .  .  .       :| . . .|:      .  .  .          . . . . .   :| \n |:    .         .      ________      :|      |:      ________         .       .   :| \n _____________________/______________|      |______/____________________________/  \n                       |__|__|__|      |..  ..|      |__|__|__|                       \n                        / / /       |..  ..|       / / /                        \n                                       |      |                                       \n                                       |. . . |                                       \n                                       |  __  |                                       \n                                       | /__ |                                       \n                                       | |__| |                                       \n                                       | |__| |                                       \n                                       | |__| |                                       \n                                       | __/ |                                       \n                                       |:    :|                                       \n                                       ______/                                       \n                                        \\|||/                                        \n                                         ||/                                         \n                                          ~~                                          \n                                                                                      ");this.root.addChild(t),t.transform.setPosition(0,320);let e=10;const s=new b,i=s.addComponent(W);t.addChild(s),i.textSize=40,i.lineHeight=40,s.transform.color=U.BLACK,i.text="HP:----------",i.align=F.center,s.transform.setPosition(0,t.transform.height/2+50);const n=t.addComponent(at);n.group="enemy",n.isTrigger=!0,n.onColliderEnter=s=>{s.entity.destroy(),e-=1,i.text=i.text.substr(0,i.text.length-1),e<=0&&(t.destroy(),this.gameOver()),console.log("碰撞拉")}}initPlayer(){const t=this.getAscIIModel("                                 __                                 \n                          ______/||______                          \n                         |______||||______|                         \n                         |      ||||      |                         \n                         '---___ || ___---'                         \n                               | || |                               \n                               |    |                               \n                               | . .|                               \n                               |  . |                               \n                  _______     _|    |_     _______                  \n  _______________|_______|..-~:| . .|:~-..|_______|_______________  \n /________________:  .        :| .  |:       .   :________________ \n |:    .       .     .        :| .  |:       .         .     .   :| \n |:    . . . . .  .  .  .     :|. . |:    .  .  .      . . . .   :| \n |:    .       .  ________    :|    |:    ________     .     .   :| \n _______________/____________|    |____/______________________/  \n                 |__|__|__|    |.  .|    |__|__|__|                 \n                  / / /     |.  .|     / / /                  \n                               | __ |                               \n                               |/__|                               \n                               ||__||                               \n                               |__/|                               \n                               |    |                               \n                               ____/                               \n                                |||                                \n                                ||/                                \n                                 ~~                                 \n                                                                    ");t.name="player",console.log("player初始化"),this.root.addChild(t),t.transform.scaleY=-1,console.log("root",this.root),t.transform.setPosition(0,-350),console.log("player设置坐标后",t.transform.getRect());const e=new ht(t);e.startEvent=()=>{t.startPoint=new E(t.transform.position)},e.moveEvent=e=>{const s=t.startPoint;t.transform.setPosition(s.x+e.x,s.y+e.y)},t.addComponent(at).group="player",this.player=t}shootOneBullet(){const t=this.getBullet();this.root.addChild(t);const e=new E(this.player.transform.x,this.player.transform.top);t.transform.setPosition(e);const s=new ot(t.transform);s.by({y:300},1).onComplete((()=>{if(t.transform.y>=this.BOUND_UP+2*t.transform.height)return t.destroy(),void console.log("bullet销毁");s.start()})).start()}initBullet(){this.bulletPreNode=this.getAscIIModel("/\\"),this.bulletPreNode.addComponent(at).group="player_bullet",this.bulletPreNode.active=!1}getBullet(t){const e=this.getAscIIModel("/\\");return e.addComponent(at).group="player_bullet",e}setRoot(){this.root=this.canvas.entity,this.BOUND_WIDTH=this.root.transform.width,this.BOUND_HEIGHT=this.root.transform.height,this.BOUND_LEFT=this.root.transform.left,this.BOUND_RIGHT=this.root.transform.right,this.BOUND_DOWN=this.root.transform.down,this.BOUND_UP=this.root.transform.top,console.log("----------------------------------"),console.log("游戏画布宽度：",this.BOUND_WIDTH),console.log("游戏画布高度：",this.BOUND_HEIGHT),console.log("画布左边界坐标：",this.BOUND_LEFT),console.log("画布右边界坐标：",this.BOUND_RIGHT),console.log("画布上边界坐标：",this.BOUND_UP),console.log("画布下边界坐标：",this.BOUND_DOWN),console.log("----------------------------------")}getAscIIModel(t){const e=new b,s=e.addComponent(W);return s.text=t,s.textSize=10,s.lineHeight=10,s.align=W.TextAlignType.center,e.transform.color=U.BLACK,console.log("模型"+e.transform.entity.name,e.transform.getRect()),e}}class ht{constructor(t){this.isAllowTouch=!0,this.target=t,this.addEventHandler()}setAllowTouch(t){this.isAllowTouch=t}addEventHandler(){this.target.listen(b.EventType.MOUSE_DOWN,(t=>{this.isAllowTouch&&(console.log("mousedown执行了"),this.startPoint=t.getLocation(),console.log("startPoint change",this.startPoint),this.startEvent())}),this),this.target.listen(b.EventType.MOUSE_UP,(t=>{this.isAllowTouch&&this.touchEnd(t)}),this),this.target.listen(b.EventType.MOUSE_PRESS,(t=>{this.isAllowTouch&&this.touchMove(t)}),this)}touchEnd(t){this.endPoint=t.getLocation()}touchMove(t){this.movePoint=t.getLocation(),this.finishUserMove()}finishUserMove(){const t=this.movePoint.sub(this.startPoint);this.moveEvent(t)}destroy(){this.target.listenOff(b.EventType.MOUSE_DOWN),this.target.listenOff(b.EventType.MOUSE_UP),this.target.listenOff(b.EventType.MOUSE_PRESS)}}class at extends S{constructor(){super(...arguments),this._group="default",this._isTrigger=!1}set group(t){this._group=t}get group(){return this._group}set isTrigger(t){1==t?this.openTriggerCheck():this.closeTriggerCheck(),this._isTrigger=t}get isTrigger(){return this._isTrigger}updateBox(){this.box=this.entity.transform.getRect()}checkCollision(){const t=at._groupMap.get(this.group);t&&t.forEach((t=>{this.getGroupInsts(t).forEach((t=>{this.isCollision(t)&&this.onColliderEnter(t)}))}))}getGroupInsts(t){return at._insts.filter((e=>e.group==t))}isCollision(t){return this.box.intersects(t.box)}onLoad(){at.addComInst(this),this.entity.listen(b.EventType.POSITION_CHANGED,this.updateBox,this),this.box=this.entity.transform.getRect()}onDestroy(){this.entity.listenOff(b.EventType.POSITION_CHANGED,this.updateBox,this),at.deleteComInst(this)}openTriggerCheck(){}update(){this.isTrigger&&this.checkCollision()}closeTriggerCheck(){}static addComInst(t){this._insts.push(t)}static deleteComInst(t){at.deleteItemFromList(t,at._insts)}static deleteItemFromList(t,e){let s=!1;for(let i=0;i<e.length;i++)if(t==e[i]){e.splice(i,1),s=!0;break}s||console.warn("deleteItemFromList方法未找到要删除的元素")}static changeItemFromList(t,e,s){let i=!1;for(let n=0;n<s.length;n++)if(t==s[n]){s[n]=e,i=!0;break}i||console.warn("deleteItemFromList方法未找到要改变的元素")}}at._groupMap=new Map([["enemy",["player_bullet"]]]),at._insts=[];class lt{static nextWorld(){this.demoInd++,this.demoInd=this.demoInd<this.demos.length?this.demoInd:0,u.Instance.runWorld(this.demos[this.demoInd].name),lt.addControlEntity()}static addControlEntity(){const t=new b;t.addComponent(ct),u.Instance.world.add(t)}static main(){const t=new u;t.debugMode=!0,t.init();const e=[];e.push(function(){const t=new A("demo2");return t.init=()=>{return e=this,s=void 0,n=function*(){const e=new b;e.transform.setPosition(100,-200);const s=e.addComponent(H),i=new B;yield i.setImageAsync("graphics/audio_test.png"),s.spriteFrame=i,console.log("图片加载完成");const n=new b;n.transform.setPosition(100,-300);const o=n.addComponent(W);o.text="lalala",o.setAlign(W.TextAlignType.center),e.listen(v.MOUSE_DOWN,(t=>{e.transform.getRect().collidePoint([t.x,t.y])&&(R.play("audio/bell.ogg"),console.log("play"),e.transform.x+=30,e.transform.angle+=15,n.transform.angle+=15)})),t.add(e),t.add(n)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(r,h)}a((n=n.apply(e,s||[])).next())}));var e,s,i,n},t}()),e.push(this.demo1()),e.push(function(){const t=new A("demo4");return t.init=()=>{const e=new b;e.addComponent(Q),t.add(e)},t}()),e.push(function(){const t=new A("demo5");return t.init=()=>{const e=new b;e.addComponent(q).init(240,-240),e.listen(b.EventType.KEY_DOWN,(t=>{switch(console.log("key",t),t){case d.A:e.transform.x-=16;break;case d.D:e.transform.x+=16;break;case d.W:e.transform.y+=16;break;case d.S:e.transform.y-=16}}),this),t.add(e)},t}()),this.demos=e;for(let s=0;s<e.length;s++){const i=e[s];t.addWorld(i)}t.runWorld(e[0].name),lt.addControlEntity()}static demo1(){const t=new A("demo1");return t.init=()=>{const e=new b("root");e.addComponent(G);const s=e.addComponent(W);s.setAlign(W.TextAlignType.center),s.text="root",t.add(e);const i=new b("child1"),n=i.addComponent(W);n.setAlign(W.TextAlignType.center),i.transform.setPosition(100,0),n.text="child1",e.addChild(i),new b("child2").setParent(e),console.log("entity",e),setTimeout((()=>{p.world==t&&new rt}),3e3)},t}}lt.demoInd=0;class ct extends S{keyDown(t){t==d.DOWN&&lt.nextWorld()}start(){this.entity.listen(v.KEY_DOWN,this.keyDown,this)}}lt.main()})();